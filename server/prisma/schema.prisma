generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Search {
  id        String   @id @default(cuid())
  query     String   @unique
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id              String          @id @default(cuid())
  email           String          @unique
  username        String          @unique
  password        String
  avatar          String?
  bio             String?
  location        String?
  latitude        Float?
  longitude       Float?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  language        String          @default("en") @db.VarChar(5)
  settings        Json?
  role            String          @default("user") @db.VarChar(16)
  isDeprecated    Boolean         @default(false)
  createdById     String?
  updatedById     String?
  lastLogin       DateTime?
  auditLogs       AuditLog[]
  createdBeans    Bean[]          @relation("BeanCreatedBy")
  updatedBeans    Bean[]          @relation("BeanUpdatedBy")
  comments        Comment[]
  favorites       Favorite[]
  notifications   Notification[]
  createdReviews  Review[]        @relation("ReviewCreatedBy")
  updatedReviews  Review[]        @relation("ReviewUpdatedBy")
  reviews         Review[]
  uploadedImages  RoasterImage[]
  createdPeople   RoasterPerson[] @relation("PersonCreatedBy")
  updatedPeople   RoasterPerson[] @relation("PersonUpdatedBy")
  personRoles     RoasterPerson[] @relation("UserPersonRole")
  createdRoasters Roaster[]       @relation("RoasterCreatedBy")
  roasters        Roaster[]
  updatedRoasters Roaster[]       @relation("RoasterUpdatedBy")
  createdBy       User?           @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers    User[]          @relation("UserCreatedBy")
  updatedBy       User?           @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  updatedUsers    User[]          @relation("UserUpdatedBy")

  @@map("users")
}

model Roaster {
  id                 String                 @id @default(cuid())
  name               String                 @unique
  description        String?
  email              String?
  phone              String?
  website            String?
  address            String?
  city               String?
  state              String?
  zipCode            String?
  country            String                 @default("US")
  latitude           Float?
  longitude          Float?
  images             String[]
  hours              Json?
  verified           Boolean                @default(false)
  featured           Boolean                @default(false)
  rating             Float                  @default(0)
  reviewCount        Int                    @default(0)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  ownerId            String?
  onlineOnly         Boolean                @default(false)
  createdById        String?
  updatedById        String?
  showHours          Boolean                @default(true)
  // Consolidated social networks as JSON (key -> url/handle).
  // We keep legacy individual columns for backward compatibility during migration.
  socialNetworks     Json?
  founded            Int?
  beans              Bean[]
  favorites          Favorite[]
  reviews            Review[]
  roasterImages      RoasterImage[]
  people             RoasterPerson[]
  sourceCountries    RoasterSourceCountry[]
  roasterSpecialties RoasterSpecialty[]
  suggestions        RoasterSuggestion[]
  createdBy          User?                  @relation("RoasterCreatedBy", fields: [createdById], references: [id])
  owner              User?                  @relation(fields: [ownerId], references: [id])
  updatedBy          User?                  @relation("RoasterUpdatedBy", fields: [updatedById], references: [id])
    sourceType         RoasterSourceType?
    sourceDetails      String?

  @@map("roasters")
}
  enum RoasterSourceType {
    Scout
    Google
    Reddit
    ChatGPT
    YouTube
    Instagram
    TikTok
    API
    Other
  }

model RoasterPerson {
  id          String   @id @default(cuid())
  roasterId   String
  firstName   String
  lastName    String?
  email       String?
  mobile      String?
  linkedinUrl String?
  bio         String?
  userId      String?
  roles       String[]
  isActive    Boolean  @default(true)
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?
  title       String?
  createdBy   User?    @relation("PersonCreatedBy", fields: [createdById], references: [id])
  roaster     Roaster  @relation(fields: [roasterId], references: [id], onDelete: Cascade)
  updatedBy   User?    @relation("PersonUpdatedBy", fields: [updatedById], references: [id])
  user        User?    @relation("UserPersonRole", fields: [userId], references: [id])

  @@unique([roasterId, email])
  @@map("roaster_people")
}

model RoasterImage {
  id           String   @id @default(cuid())
  url          String
  publicId     String
  filename     String?
  description  String?
  isPrimary    Boolean  @default(false)
  uploadedAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt
  roasterId    String
  uploadedById String
  roaster      Roaster  @relation(fields: [roasterId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@map("roaster_images")
}

model Bean {
  id           String   @id @default(cuid())
  name         String
  description  String?
  origin       String?
  process      String?
  roastLevel   String?
  price        Float?
  weight       String?
  tastingNotes String[]
  availability Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  roasterId    String
  createdById  String?
  updatedById  String?
  createdBy    User?    @relation("BeanCreatedBy", fields: [createdById], references: [id])
  roaster      Roaster  @relation(fields: [roasterId], references: [id])
  updatedBy    User?    @relation("BeanUpdatedBy", fields: [updatedById], references: [id])

  @@map("beans")
}

model Review {
  id          String    @id @default(cuid())
  rating      Int
  title       String?
  content     String?
  images      String[]
  helpful     Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  roasterId   String?
  createdById String?
  updatedById String?
  comments    Comment[]
  createdBy   User?     @relation("ReviewCreatedBy", fields: [createdById], references: [id])
  roaster     Roaster?  @relation(fields: [roasterId], references: [id])
  updatedBy   User?     @relation("ReviewUpdatedBy", fields: [updatedById], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@map("reviews")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  roasterId String
  roaster   Roaster  @relation(fields: [roasterId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, roasterId])
  @@map("favorites")
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model Region {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  countries   Country[]

  @@map("regions")
}

model Country {
  id        String                 @id @default(cuid())
  name      String                 @unique
  code      String                 @unique @db.VarChar(2)
  flagSvg   String?
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  regionId  String
  region    Region                 @relation(fields: [regionId], references: [id])
  roasters  RoasterSourceCountry[]

  @@map("countries")
}

model RoasterSourceCountry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  roasterId String
  countryId String
  country   Country  @relation(fields: [countryId], references: [id])
  roaster   Roaster  @relation(fields: [roasterId], references: [id], onDelete: Cascade)

  @@unique([roasterId, countryId])
  @@map("roaster_source_countries")
}

model Specialty {
  id           String                 @id @default(cuid())
  deprecated   Boolean                @default(false)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  roasters     RoasterSpecialty[]
  translations SpecialtyTranslation[]

  @@map("specialties")
}

model SpecialtyTranslation {
  id          String    @id @default(cuid())
  specialtyId String
  language    String    @db.VarChar(5)
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([specialtyId, language])
  @@map("specialty_translations")
}

model RoasterSpecialty {
  id          String    @id @default(cuid())
  roasterId   String
  specialtyId String
  createdAt   DateTime  @default(now())
  roaster     Roaster   @relation(fields: [roasterId], references: [id], onDelete: Cascade)
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([roasterId, specialtyId])
  @@map("roaster_specialties")
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  entityName String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  city       String?
  country    String?
  createdAt  DateTime @default(now())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model RoasterSuggestion {
  id                String   @id @default(cuid())
  roasterName       String
  city              String
  state             String?
  country           String
  website           String
  submitterRole     String
  submitterFirstName String
  submitterLastName String?
  submitterEmail    String
  submitterPhone    String?
  status            String   @default("new") // new, approved, in_progress, rejected, done
  adminNotes        String?
  roasterId         String?  // ID of the created roaster
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  reviewedAt        DateTime?
  reviewedById      String?
  roaster           Roaster? @relation(fields: [roasterId], references: [id])

  @@map("roaster_suggestions")
}
